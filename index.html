<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AAC Activity Reports</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://antloh-sh.github.io/membership/auth-config.js"></script>

    <style>
        :root { --primary: #3ecf8e; --bg: #f0f2f5; --text: #1c1c1c; --grey: #94a3b8; --danger: #ef4444; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 15px; color: var(--text); }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { text-align: center; margin-top: 0; color: var(--primary); }
        label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        
        /* Password Wrapper */
        .password-wrapper { position: relative; }
        .toggle-password { position: absolute; right: 12px; top: 12px; cursor: pointer; color: var(--grey); font-size: 0.8rem; user-select: none; }

        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .links-container { text-align: center; margin-top: 15px; }
        .link-btn { background: none; border: none; color: #64748b; text-decoration: underline; font-size: 0.9rem; cursor: pointer; padding: 5px; }
        
        .data-badge { display: inline-block; background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; color: #475569; margin-bottom: 20px; }
        .result-box { background: #f8fafc; border-radius: 8px; padding: 15px; overflow-x: auto; border: 1px solid #e2e8f0; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f1f5f9; text-align: left; padding: 10px; border-bottom: 2px solid #cbd5e1; }
        td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .hidden { display: none; }
        .message { padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .error { background: #fee2e2; color: #ef4444; }
        .success { background: #dcfce7; color: #16a34a; }
        .logout-btn { background: none; color: var(--danger); border: 1px solid var(--danger); margin-top: 20px; padding: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="app-title">Activity Reports</h2>
    <div id="msg" class="message hidden"></div>

    <div id="login-section">
        <label>Email</label>
        <input type="email" id="email" placeholder="Enter your email">
        <label>Password</label>
        <div class="password-wrapper">
            <input type="password" id="password" placeholder="Enter password">
            <span class="toggle-password" onclick="togglePassword()">Show</span>
        </div>
        <button onclick="signIn()">Sign In</button>
        <div class="links-container">
            <button class="link-btn" onclick="forgotPassword()">Forgot Password?</button>
        </div>
    </div>

    <div id="reset-section" class="hidden">
        <p style="font-size: 0.9rem; color: #64748b;">Enter your email to receive a password reset link.</p>
        <label>Email</label>
        <input type="email" id="reset-email" placeholder="Enter your email">
        <button onclick="handleReset()">Send Reset Link</button>
        <div class="links-container">
            <button class="link-btn" onclick="showLogin()">Back to Login</button>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="data-coverage" class="data-badge">Checking data coverage...</div>
        <label>Select Report Type</label>
        <select id="report-select">
            <option value="" disabled selected>-- Choose a report --</option>
        </select>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Start Month</label>
                <input type="month" id="start-month">
            </div>
            <div style="flex: 1;">
                <label>End Month</label>
                <input type="month" id="end-month">
            </div>
        </div>

        <button id="run-btn" onclick="runReport()">Execute Query</button>
        <div id="result-container" class="hidden">
            <div id="result-box" class="result-box"></div>
        </div>
        <button onclick="signOut()" class="logout-btn">Sign Out</button>
    </div>
</div>

<script>
    function togglePassword() {
        const pwInput = document.getElementById('password');
        const toggleBtn = document.querySelector('.toggle-password');
        if (pwInput.type === 'password') {
            pwInput.type = 'text';
            toggleBtn.innerText = 'Hide';
        } else {
            pwInput.type = 'password';
            toggleBtn.innerText = 'Show';
        }
    }

    async function forgotPassword() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('reset-section').classList.remove('hidden');
        document.getElementById('app-title').innerText = "Reset Password";
    }

    function showLogin() {
        document.getElementById('reset-section').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('app-title').innerText = "Activity Reports";
    }

    async function handleReset() {
        const email = document.getElementById('reset-email').value;
        if (!email) return showMsg("Please enter your email", "error");
        
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href // Redirects back to this page
        });

        if (error) showMsg(error.message, "error");
        else showMsg("Reset link sent! Check your email.", "success");
    }

    async function loadReports() {
        try {
            const response = await fetch('reports.json');
            const data = await response.json();
            const select = document.getElementById('report-select');
            
            // Accessing data.reports based on your JSON structure
            const reports = data.reports || data;
            
            reports.forEach(report => {
                const opt = document.createElement('option');
                opt.value = report.id;
                opt.innerText = report.name;
                select.appendChild(opt);
            });
        } catch (error) {
            console.error("Config Error:", error);
        }
    }

    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) showMsg(error.message, 'error');
        else window.location.reload();
    }

    async function signOut() {
        await supabaseClient.auth.signOut();
        window.location.reload();
    }

    function showMsg(text, type) {
        const msgDiv = document.getElementById('msg');
        msgDiv.innerText = text;
        msgDiv.className = `message ${type}`;
        msgDiv.classList.remove('hidden');
        setTimeout(() => msgDiv.classList.add('hidden'), 5000);
    }

    window.onload = async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            loadReports();
        }
    };
</script>
</body>
</html>

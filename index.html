<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AAC Activity Reports</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://antloh-sh.github.io/membership/auth-config.js"></script>

    <style>
        :root { --primary: #3ecf8e; --bg: #f0f2f5; --text: #1c1c1c; --grey: #94a3b8; --danger: #ef4444; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 15px; color: var(--text); }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { text-align: center; margin-top: 0; color: var(--primary); }
        h3 { margin-bottom: 5px; font-size: 1.1rem; }
        label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: opacity 0.2s; }
        button:disabled { background: var(--grey); cursor: not-allowed; }
        .data-badge { display: inline-block; background: #e2e8f0; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; color: #475569; margin-bottom: 20px; }
        #result-container { margin-top: 30px; border-top: 2px solid #f1f5f9; padding-top: 20px; }
        .result-box { background: #f8fafc; border-radius: 8px; padding: 15px; overflow-x: auto; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f1f5f9; text-align: left; padding: 10px; border-bottom: 2px solid #cbd5e1; }
        td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .big-number { display: block; text-align: center; font-size: 3.5rem; font-weight: 800; color: var(--primary); }
        .hidden { display: none; }
        .message { padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-weight: bold; }
        .error { background: #fee2e2; color: #ef4444; }
        .logout-btn { background: none; color: var(--danger); border: 1px solid var(--danger); margin-top: 20px; padding: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <h2>Activity Reports</h2>
    
    <div id="msg" class="message hidden"></div>

    <div id="login-section">
        <label>Email</label>
        <input type="email" id="email" placeholder="Enter your email">
        <label>Password</label>
        <input type="password" id="password" placeholder="Enter password">
        <button onclick="signIn()">Sign In</button>
    </div>

    <div id="main-app" class="hidden">
        <div id="data-coverage" class="data-badge">Checking data coverage...</div>

        <label for="report-select">Select Report Type</label>
        <select id="report-select">
            <option value="" disabled selected>-- Choose a report --</option>
        </select>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Start Month</label>
                <input type="month" id="start-month" onchange="updateMinDate()">
            </div>
            <div style="flex: 1;">
                <label>End Month</label>
                <input type="month" id="end-month">
            </div>
        </div>

        <button id="run-btn" onclick="runReport()">Execute Query</button>

        <div id="result-container" class="hidden">
            <h3>Query Result</h3>
            <div id="result-box" class="result-box"></div>
        </div>

        <button onclick="signOut()" class="logout-btn">Sign Out</button>
    </div>
</div>

<script>
    // BUSINESS LOGIC: Report Management
    async function loadReports() {
        try {
            // Using './' ensures it looks in the same directory as index.html
            const response = await fetch('./reports.json');
            
            if (!response.ok) throw new Error('File not found');
            
            const data = await response.json();
            const select = document.getElementById('report-select');
            
            // Keep the placeholder, clear the rest
            select.innerHTML = '<option value="" disabled selected>-- Choose a report --</option>';
            
            data.forEach(report => {
                const opt = document.createElement('option');
                opt.value = report.rpc_name;
                opt.innerText = report.display_name;
                select.appendChild(opt);
            });
        } catch (error) {
            console.error("Config Error:", error);
            // This confirms the app is running but the JSON file is unreachable
            showMsg("Cannot find reports.json in this folder", "error");
        }
    }

    async function fetchDataRange() {
        const { data, error } = await supabaseClient.rpc('get_activity_date_range');
        const badge = document.getElementById('data-coverage');
        if (error || !data || !data.min_date) {
            badge.innerText = "Data coverage unavailable.";
            return;
        }
        const options = { year: 'numeric', month: 'short' };
        const minD = new Date(data.min_date);
        const maxD = new Date(data.max_date);
        
        badge.innerHTML = `<strong>Data Coverage:</strong> ${minD.toLocaleDateString('en-SG', options)} â€” ${maxD.toLocaleDateString('en-SG', options)}`;
        
        const minISO = data.min_date.substring(0, 7);
        const maxISO = data.max_date.substring(0, 7);
        document.getElementById('start-month').min = minISO;
        document.getElementById('start-month').value = minISO;
        document.getElementById('end-month').min = minISO;
        document.getElementById('end-month').max = maxISO;
        document.getElementById('end-month').value = maxISO;
    }

    function updateMinDate() {
        document.getElementById('end-month').min = document.getElementById('start-month').value;
    }

    async function runReport() {
        const reportRPC = document.getElementById('report-select').value;
        const startM = document.getElementById('start-month').value;
        const endM = document.getElementById('end-month').value;
        const btn = document.getElementById('run-btn');
        const resultContainer = document.getElementById('result-container');
        const resultBox = document.getElementById('result-box');

        if (!reportRPC || !startM || !endM) return showMsg("Select report and date range", "error");

        const start_date = `${startM}-01`;
        const endParts = endM.split('-');
        const lastDay = new Date(endParts[0], endParts[1], 0).getDate();
        const end_date = `${endM}-${lastDay}`;

        btn.innerText = "Calculating...";
        btn.disabled = true;

        try {
            const { data, error } = await supabaseClient.rpc(reportRPC, { start_date, end_date });
            if (error) throw error;

            resultContainer.classList.remove('hidden');
            if (Array.isArray(data)) {
                if (data.length === 0) {
                    resultBox.innerHTML = "<p style='text-align:center'>No records found.</p>";
                } else {
                    const headers = Object.keys(data[0]);
                    let tableHtml = `<table><thead><tr>${headers.map(h => `<th>${h.replace(/_/g, ' ')}</th>`).join('')}</tr></thead><tbody>`;
                    data.forEach(row => {
                        tableHtml += `<tr>${headers.map(h => `<td>${row[h] ?? '-'}</td>`).join('')}</tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    resultBox.innerHTML = tableHtml;
                }
            } else {
                resultBox.innerHTML = `<span class="big-number">${data ?? 0}</span>`;
            }
        } catch (err) {
            showMsg(err.message, "error");
        } finally {
            btn.innerText = "Execute Query";
            btn.disabled = false;
        }
    }

    function showMsg(text, type) {
        const msgDiv = document.getElementById('msg');
        msgDiv.innerText = text;
        msgDiv.className = `message ${type}`;
        msgDiv.classList.remove('hidden');
        setTimeout(() => msgDiv.classList.add('hidden'), 5000);
    }

    function showView(view) {
        document.getElementById('login-section').classList.toggle('hidden', view !== 'login');
        document.getElementById('main-app').classList.toggle('hidden', view !== 'app');
    }

    async function signIn() {
        const { error } = await supabaseClient.auth.signInWithPassword({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        });
        if (error) showMsg(error.message, 'error');
        else window.location.reload();
    }

    window.onload = async () => {
        resetIdleTimer();
        const { data: { session } } = await supabaseClient.auth.getSession();
        
        setTimeout(() => {
            if (session) {
                showView('app');
                fetchDataRange();
                loadReports();
            } else {
                showView('login');
            }
        }, 100);
    };
</script>
</body>
</html>

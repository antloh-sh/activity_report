<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AAC Activity Reports</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3ecf8e; --bg: #f0f2f5; --text: #1c1c1c; --grey: #94a3b8; --danger: #ef4444; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 15px; color: var(--text); }
        .container { width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { text-align: center; margin-top: 0; color: var(--primary); }
        h3 { margin-bottom: 5px; font-size: 1.1rem; }
        label { font-size: 0.85rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0 18px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }
        button:disabled { background: var(--grey); cursor: not-allowed; }
        .secondary-btn { background: #f1f5f9; color: #475569; font-size: 0.9rem; padding: 12px; margin-top: 10px; }
        .report-card { background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .result-box { margin-top: 10px; font-size: 1.1rem; color: var(--text); overflow-x: auto; }
        .big-number { font-size: 2.5rem; font-weight: bold; color: #4338ca; text-align: center; display: block; padding: 10px; }
        .hidden { display: none; }
        .logout-btn { background: var(--danger) !important; margin-top: 40px; }
        .message { padding: 15px; border-radius: 8px; text-align: center; margin-top: 10px; font-weight: bold; font-size: 0.9rem; }
        .error { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .success { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }
        .data-badge { background: #eff6ff; color: #1d4ed8; padding: 12px; border-radius: 8px; font-size: 0.85rem; text-align: center; margin-bottom: 20px; border: 1px dashed #bfdbfe; line-height: 1.4; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        th { background: #f1f5f9; padding: 12px 10px; text-align: left; text-transform: uppercase; color: #64748b; font-size: 0.75rem; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; }
        tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="title">AAC Activity Reports</h2>

    <div id="login-section">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signIn()">Sign In</button>
        <button class="secondary-btn" onclick="showView('reset-section')">Forgot Password?</button>
    </div>

    <div id="reset-section" class="hidden">
        <p style="text-align: center; font-size: 0.9rem;">Enter email to receive a reset link.</p>
        <input type="email" id="reset-email" placeholder="Email Address">
        <button onclick="sendResetEmail()">Send Reset Link</button>
        <button class="secondary-btn" onclick="showView('login-section')">Back to Login</button>
    </div>

    <div id="main-app" class="hidden">
        <div id="data-coverage" class="data-badge">Checking available database range...</div>
        
        <h3>Report Settings</h3>
        
        <label>Query Type</label>
        <select id="report-select">
            <option value="get_gui_session_count">GUI Session Count</option>
            <option value="get_gui_activity_breakdown">GUI Activity List</option>
            <option value="get_gui_unique_member_count_in_boundary">GUI Unique Members (In Boundary, Age 60+)</option>
            <option value="get_active_seniors_all_count">Engaged Seniors (In Boundary, Age 60+, 2+ Sessions)</option>
            <option value="get_all_cfs_breakdown">Activity Session Count & CFS Averages (All members)</option>
        </select>

        <label>Start Month</label>
        <input type="month" id="start-month" onchange="updateMinDate()">

        <label>End Month</label>
        <input type="month" id="end-month">

        <button id="run-btn" onclick="runReport()">Execute Query</button>

        <div id="report-result" class="report-card hidden">
            <label id="result-label">Report Output:</label>
            <div id="result-value" class="result-box"></div>
        </div>

        <button onclick="signOut()" class="logout-btn">Sign Out</button>
    </div>

    <div id="msg" class="message hidden"></div>
</div>

<script>
    const SUPABASE_URL = 'https://qesgfxwgbggjyvngftee.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_MJQrnWCSsg0naLA9hxkPzQ__diYSGYi';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showMsg(text, type) {
        const msgDiv = document.getElementById('msg');
        msgDiv.innerText = text;
        msgDiv.className = `message ${type}`;
        msgDiv.classList.remove('hidden');
        setTimeout(() => msgDiv.classList.add('hidden'), 5000);
    }

    function showView(viewId) {
        const sections = ['login-section', 'reset-section', 'main-app'];
        sections.forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
    }

    async function fetchDataRange() {
        const { data, error } = await supabaseClient.rpc('get_activity_date_range');
        const badge = document.getElementById('data-coverage');
        if (error || !data.min_date) {
            badge.innerText = "Data coverage information unavailable.";
            return;
        }
        const options = { year: 'numeric', month: 'short' };
        const min = new Date(data.min_date).toLocaleDateString('en-SG', options);
        const max = new Date(data.max_date).toLocaleDateString('en-SG', options);
        badge.innerHTML = `<strong>Data Coverage:</strong> ${min} â€” ${max}`;
    }

    function updateMinDate() {
        const startVal = document.getElementById('start-month').value;
        const endInput = document.getElementById('end-month');
        endInput.min = startVal;
        if (endInput.value && endInput.value < startVal) endInput.value = '';
    }

    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if(!email || !password) return showMsg("Enter credentials", "error");
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) return showMsg(error.message, 'error');
        window.location.reload();
    }

    async function signOut() {
        await supabaseClient.auth.signOut();
        window.location.reload();
    }

    async function sendResetEmail() {
        const email = document.getElementById('reset-email').value;
        if (!email) return showMsg("Enter email", "error");
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
        if (error) return showMsg(error.message, "error");
        showMsg("Reset link sent!", "success");
    }

    async function runReport() {
        const reportSelect = document.getElementById('report-select');
        const reportRPC = reportSelect.value;
        
        const startM = document.getElementById('start-month').value;
        const endM = document.getElementById('end-month').value;
        const resultContainer = document.getElementById('report-result');
        const resultBox = document.getElementById('result-value');
        const btn = document.getElementById('run-btn');

        if (!startM || !endM) return showMsg("Select date range", "error");
        if (endM < startM) return showMsg("Invalid date range", "error");

        const start_date = `${startM}-01`;
        const endParts = endM.split('-');
        const lastDay = new Date(endParts[0], endParts[1], 0).getDate();
        const end_date = `${endM}-${lastDay}`;

        btn.innerText = "Calculating...";
        btn.disabled = true;

        try {
            const { data, error } = await supabaseClient.rpc(reportRPC, {
                start_date: start_date,
                end_date: end_date
            });

            if (error) throw error;
            resultContainer.classList.remove('hidden');

            if (Array.isArray(data)) {
                if (data.length === 0) {
                    resultBox.innerHTML = "<p style='text-align:center'>No matching records found.</p>";
                } else {
                    const headers = Object.keys(data[0]);
                    let tableHtml = `<table><thead><tr>`;
                    headers.forEach(h => tableHtml += `<th>${h.replace(/_/g, ' ')}</th>`);
                    tableHtml += `</tr></thead><tbody>`;
                    data.forEach(row => {
                        tableHtml += `<tr>`;
                        headers.forEach(h => tableHtml += `<td>${row[h] ?? '-'}</td>`);
                        tableHtml += `</tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    resultBox.innerHTML = tableHtml;
                }
            } else {
                resultBox.innerHTML = `<span class="big-number">${data ?? 0}</span>`;
            }
        } catch (err) {
            showMsg(err.message, "error");
        } finally {
            btn.innerText = "Execute Query";
            btn.disabled = false;
        }
    }

    window.onload = async () => {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
            showView('main-app');
            fetchDataRange();
        } else {
            showView('login-section');
        }
    };
</script>
</body>
</html>
